<div style="padding: 60px">
    <h4>Segment from {{start}}s to {{end}}s</h4>
    <div id="top_x_div"></div>
</div>

<script>
    google.charts.load('current', {
        'packages': ['bar']
    });
    google.charts.setOnLoadCallback(drawStuff);
    // instrument_names = ['Cello', 'Acoustic guitar', 'Electric guitar', 'Church organs', 'Piano', 'Violin']
    var checkedBoxes = [...document.querySelectorAll('input[name=instruments]:checked')].map(e => e.value)
    var instrument_names = ['accordion', 'banjo', 'bass', 'cello', 'clarinet', 'cymbals',
                    'drums', 'flute', 'guitar', 'mallet_percussion', 'mandolin',
                    'organ', 'piano', 'saxophone', 'synthesizer', 'trombone',
                    'trumpet', 'ukulele', 'violin', 'voice']
    var family_names = ['reed instrument', 'string instrument', 'string instrument', 'string instrument', 'reed instrument', 'percussion', 
                    'percussion', 'woodwind instrument', 'string instrument', 'percussion instrument', 'string instrument',
                    'keyboard', 'keyboard', 'reed instrument', ' ', 'brass instrument',
                    'brass instrument', 'string instrument', 'string instrument', ' ']
    function drawStuff() {
        var raw_results = JSON.parse("{{result}}");
        /*if(checkedBoxes.length) {
            results = checkedBoxes.map(function(value, i) {
                return [instrument_names[value], raw_results[value]];
            });
        }*/
        //else {
        results = raw_results.map(function(value, i) {
            return [instrument_names[i], value];
        });           
        //}
        var header = [
            ['Instrument', 'Probability']
        ];
        data = header.concat(results);
        console.log(data);
        var data = new google.visualization.arrayToDataTable(data);

        var options = {
            width: 20*80,
            legend: {
                position: 'none'
            },
            axes: {
                x: {
                    0: {
                        side: 'top',
                    } // Top x-axis.
                }
            },
            bar: {
                groupWidth: "90%"
            }
        };

        var chart = new google.charts.Bar(document.getElementById('top_x_div'));
        // Convert the Classic options to Material options.
        chart.draw(data, google.charts.Bar.convertOptions(options));
    };

    // Add regions to waveform 
    var raw_results = JSON.parse("{{result}}");
    var results = raw_results;
    /*if(checkedBoxes.length) {
        results = checkedBoxes.map(function(value, i) {
                return [raw_results[value]];
        });
    }*/

    var dominantInstrumentName = "";
    var maxValueIndex = -1;
    var maxValue = 0.9;
    var thresvalue = 0.85;
    var nameSet = new Set();
    nameSet.add(' ')
    for (var i = 0; i < results.length; i++) {
        if (results[i] > maxValue) {
            maxValueIndex = i;
            if(checkedBoxes.length) {
                if(checkedBoxes.includes(String(maxValueIndex))) {
                    dominantInstrumentName += instrument_names[maxValueIndex] + '\n';
                }
                else {
                    if(!nameSet.has(family_names[maxValueIndex])){
                        dominantInstrumentName += family_names[maxValueIndex] + '\n';
                        nameSet.add(family_names[maxValueIndex])
                    }
                }
            }
            else {
                dominantInstrumentName += instrument_names[maxValueIndex] + '\n';
            }
        }
        else if (results[i] > thresvalue) {
            if(!nameSet.has(family_names[i])){
                dominantInstrumentName += family_names[i] + '\n';
                nameSet.add(family_names[i])
            }           
        } 
    }

    console.log("dominant instrument: \n", dominantInstrumentName);
    document.getElementById("dominantInstrumentName").innerText = dominantInstrumentName;
    // Remove seleted region
    // And create identical but non-draggale
    var updateLabel = function(region) {
        if (region.id != 'startend') {
            // Possible multiple regions with the same id (the same instrument and time segment)
            // Only when Math.random() pick the same number - very rare cases!
            var regions = document.querySelectorAll('region[data-id="' + region.id + '"]');
            for (index = 0; index < regions.length; index++) {
                regions[index].style.height = '80%';
                regions[index].style.top = '10%';
            }

        }
    };
    wavesurfer.on('region-created', updateLabel);
    wavesurfer.on('region-updated', updateLabel);

    var regionId = dominantInstrumentName.split('\n')[0] + "at {{ start }}, RANDOM_ID: " + Math.random();
    wavesurfer.addRegion({
        id: regionId,
        start: '{{ start }}', // time in seconds 
        end: '{{ end }}', // time in seconds 
        drag: false,
        resize: false,
        color: 'hsla(213, 92%, 85%, 0.48)',
        attributes: {
            label: '',
            top: '10%',
            height: '80%'
        }
    });


    // Disable selecting region reset
    // It speeds up queueing request to the server and is more user-friendly
    // wavesurfer.regions.list["startend"].remove();
    // // Add new, draggable region
    // wavesurfer.addRegion({
    //     id: "startend",
    //     start: '{{ end }}', // time in seconds 
    //     end: '{{ end + 1 }}', // time in seconds 
    //     drag: true,
    //     resize: false,
    //     color: 'hsla(262, 52%, 47%, 0.48)',
    // });
</script>
